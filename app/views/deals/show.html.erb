<div class="deal_container">
	<div class="deal_inner">
		<h1><%= @deal.advertiser.business_name %></h1>
		<h2><%= @deal.coupon_text %></h2>
		<p><%= @deal.description %></p>
    <p>Expires on <%= @deal.end_date.strftime('%D') %></p>
		<% if @coupon %>
      <% if @coupon.not_redeemed? && @deal.not_expired? %>
        <p><%= link_to 'Redeem', coupon_url(@coupon, redeemed: true), class: 'btn btn-danger btn-large', method: :put %></p>
      <% elsif @coupon.redeemed? %>
        <p>Thanks for using this coupon on <%= @coupon.updated_at.strftime('%D') %></p>
      <% else %>
        <p>Sorry. This deal expired on <%= @deal.end_date.strftime('%D') %></p>
      <% end %>
    <% end %>

    <% if @deal.coupons.for_user(current_authorized_user).empty? %>
      <p><b>Send a tweet to receive the deal:</b></p>
      <!-- <p>Sample: <%#= @deal.sample_tweet %></p> -->
      <% if session[:uid] %>
        <%= form_tag(coupons_url) do %>
          <%= text_area_tag :tweet, "#{@deal.sample_tweet} #{deal_url(@deal, referred: true)}" %>
          <div class="countdown">140</div>
          <%= submit_tag 'Tweet', id: 'tweet_button' %>
        <% end %>
      <% else %>
        <p><%= link_to 'Tweet to get this Deal', '/auth/twitter', class: 'tweet_btn' %></p>
      <% end %>
    <% else %>
<!--       <p>Conversation:</p>
      <%# @deal.coupons.each do |coupon| %>
        <p><%#= @coupon.tweet %> by <%#= coupon.user.username %></p>
      <%# end %> -->
    <% end %>
	</div>
</div>

<script>

  $(function(){

    $.backstretch("<%= @deal.image.image_url %>");

    $('#tweet').focus();

    function createSelection(start, end, field) {
        if ( field.createTextRange ) {
          var newend = end - start;
          var selRange = field.createTextRange();
          selRange.collapse(true);
          selRange.moveStart("character", start);
          selRange.moveEnd("character", newend);
          selRange.select();
        }
        else if( field.setSelectionRange ){
          field.setSelectionRange(start, end);
        }
        field.focus();
    }
    var target = document.getElementById('tweet');
    createSelection(0, <%= @deal.sample_tweet.length %>, target);

    function updateCountdown() {
      // 140 is the max message length
      var remaining = 140 - $('#tweet').val().length;
      if (remaining <= 10){
        $('.countdown').css('color', 'red');
      }
      else {
        $('.countdown').css('color', 'white');
      }
      if (remaining < 0){
        $('#tweet_button').attr('disabled', 'disabled');
      }
      else {
        $('#tweet_button').removeAttr('disabled');
      }
      $('.countdown').text(remaining);
    }
    updateCountdown();
    $('#tweet').change(updateCountdown);
    $('#tweet').keyup(updateCountdown);
  })

</script>